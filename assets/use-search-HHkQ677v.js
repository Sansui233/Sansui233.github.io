import{t as w}from"./layout-Ig7IE2Rm.js";import{a as p}from"./chunk-JMJ3UQ3L-CM_uFqsX.js";const v="posts-search-index.json",N="memo-search-index.json";function b(s){const u=s.disableStreamNotify?void 0:w(s.notifier,125),h=(t,a)=>{const c=[];for(const r of a)if(/^[A-Za-z]+$/.test(r)){const e=new RegExp(`\\b${r}\\b`,"i").exec(t);if(e)c.push({word:r,index:e.index});else break}else{const o=t.indexOf(r);if(o!==-1)c.push({word:r,index:o});else break}return c},l=(t,a,c)=>{for(const r of c)if(r in a)if(r==="tags"){const o=a[r];if(!o)continue;const e=o.filter(n=>t.includes(n));if(e.length>0){const n=e.map(i=>({word:i}));return s.buildResult(a,n)}}else{const o=a[r];if(typeof o!="string")continue;const e=h(o.toLowerCase(),t.map(n=>n.toLowerCase()));if(e.length!==0){const n=e.map(i=>{const f=Math.max(0,i.index-10),m=Math.min(o.length,i.index+40);return{word:i.word,excerpt:r!=="title"?o.slice(f,m).replaceAll(`
`,""):void 0}});return s.buildResult(a,n)}}return null},x=t=>{if(!t?.fields||t.fields.length===0)return s.field;const a=t.fields.filter(c=>s.field.includes(c));return a.length>0?a:s.field};return{search:async(t,a)=>{if(t=t.map(e=>e.trim()).filter(e=>e!==""),t.length===0){s.notifier([]);return}const c=x(a),r=[],o=s.data.map(e=>new Promise(n=>{const i=l(t,e,c);i&&(r.push(i),u&&u([...r])),n()}));await Promise.all(o),r.length>1&&r.sort((e,n)=>n.matches.length-e.matches.length),s.notifier([...r])}}}function E(s){const u=s.trim();if(!u)return{patterns:[]};const h=/[\s,，.。、]+/,l=u.match(/^(\w+):(.*)$/);if(l){const[,d,t]=l;return{patterns:t.split(h).map(c=>c.trim()).filter(c=>c.length>0),config:{fields:[d]}}}return{patterns:u.split(h).map(d=>d.trim()).filter(d=>d.length>0)}}function T({inputRef:s,setRes:u,initData:h}){const[l,x]=p.useState(),[d,t]=p.useState({isSearch:"ready",searchText:""}),a=p.useCallback(async()=>{if(l)return l;console.log("init search...");const{data:e,fields:n,buildResult:i}=await h();function f(S){u(S),t(g=>({...g,isSearch:"done"}))}const m=b({data:e,field:n,notifier:f,disableStreamNotify:!0,buildResult:i});return x(m),t(S=>({...S})),m},[h,u,l]),c=p.useCallback(async e=>{if(!s?.current)return;const n=s.current.value.trim();if(n.length===0)return;t(g=>({...g,isSearch:"searching",searchText:n})),globalThis.scrollTo({top:0});let i=l;i||(i=await a());const{patterns:f,config:m}=E(n);if(f.length===0){t(g=>({...g,isSearch:"done"}));return}const S=e??m;i.search(f,S)},[a,l,s]),r=p.useCallback((e,n=!0,i)=>{s.current&&(s.current.value=e,n&&c(i))},[c,s]),o=p.useCallback(()=>{t(()=>({isSearch:"ready",searchText:""}))},[]);return{searchStatus:d,resetSearchStatus:o,setTextAndSearch:r,search:c,initSearch:a}}export{N as M,v as P,b as c,E as p,T as u};
