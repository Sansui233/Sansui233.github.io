[{"_1":2},"routes/posts.$slug",{"_3":4},"data",{"_5":6,"_51":52,"_54":55},"post",{"_7":8,"_9":8,"_10":11,"_12":-5,"_13":14,"_15":16,"_21":22,"_23":24,"_25":26,"_27":28,"_39":40,"_42":43,"_44":45,"_49":50},"title","Mac上如何开机与关机时自动运行Shell脚本","slug","date","2020-11-23T16:00:00.000Z","description","draft",false,"metadata",{"_17":18,"_19":20},"readingTime",1,"wordCount",360.8,"excerpt","网上讲如何开机运行脚本的很多，但我有关机时关闭远程服务的需求。于是上外网查了一下如何在关机时执行一段脚本。\n新建一个shell文件\n这个shell中包含了你需要开机关机时运行的脚本。\n#!/bin/bash\nfunction shutdown()\n{\n\n  # 关机用的脚本放这里\n\n  exit 0\n}\n\nfunction startup()\n{\n\n  # 开机用的脚本放这里\n\n  tail -f /dev/null &\n  wait $!\n}\n\ntrap shutdown SIGTERM\ntrap shutdow","content_html","<p>网上讲如何开机运行脚本的很多，但我有关机时关闭远程服务的需求。于是上外网查了一下如何在关机时执行一段脚本。</p>\n<h2>新建一个shell文件</h2>\n<p>这个shell中包含了你需要开机关机时运行的脚本。</p>\n<pre><code class=\"language-bash\">#!/bin/bash\nfunction shutdown()\n{\n\n  # 关机用的脚本放这里\n\n  exit 0\n}\n\nfunction startup()\n{\n\n  # 开机用的脚本放这里\n\n  tail -f /dev/null &#x26;\n  wait $!\n}\n\ntrap shutdown SIGTERM\ntrap shutdown SIGKILL\n\nstartup;\n</code></pre>\n<p>以上文件我取名为launchdeamon，赋予了当前用户的执行权限。</p>\n<pre><code class=\"language-shell\">chmod 755 launchdaemon\n</code></pre>\n<h2>新建plist文件</h2>\n<p>为了让launchdeamon能在开机时自动运行，需要编写一个相应plist文件，使用launctl做到开机启动。关于launchctl和plist的作用，请先查看这篇文章：<a href=\"https://www.jianshu.com/p/b65c1d339eec\">Mac执行定时任务之launchctl</a>。</p>\n<p>plist文件的内容如下：</p>\n<pre><code class=\"language-xml\">&#x3C;?xml version=\"1.0\" encoding=\"UTF-8\"?>\n&#x3C;!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n&#x3C;plist version=\"1.0\">\n&#x3C;dict>\n&#x3C;key>Label&#x3C;/key>&#x3C;string>boot-shutdown&#x3C;/string>\n\n&#x3C;key>ProgramArguments&#x3C;/key>\n&#x3C;array>\n  &#x3C;string>$SCRIPT_PATH/launchdaemon&#x3C;/string>\n&#x3C;/array>\n\n&#x3C;key>RunAtLoad&#x3C;/key>\n&#x3C;true/>\n\n&#x3C;key>StandardOutPath&#x3C;/key>\n&#x3C;string>$LOG_PATH/boot-shutdown.log&#x3C;/string>\n\n&#x3C;key>StandardErrorPath&#x3C;/key>\n&#x3C;string>$PLOG_PATH/boot-shutdown.err&#x3C;/string>\n\n&#x3C;/dict>\n&#x3C;/plist>\n</code></pre>\n<p>plist文件以键值对的形式存储信息。以上文件的字段解释：</p>\n<ul>\n<li><code>Label</code>：标签，也就是运行该plist显示的名字。这里为boot-shutdown</li>\n<li><code>ProgramArguments</code>：<code>array</code>里可以存放多个需要运行程序。这里的<code>$SCRIPT_PATH</code>请自己修改。</li>\n<li><code>RunAtLoad</code>：开机自启，为<code>true</code></li>\n<li><code>StandardOutPath</code>：打印标准输出到某个文件，方便查看程序后台运行的结果，<code>$LOG_PATH</code>自行修改。</li>\n<li><code>StandardErrorPath</code>：打印标准错误到某个文件，同上。</li>\n</ul>\n<p>以上文件我取名为 boot-shutdown-script.plist 。</p>\n<p>由于shell脚本的执行权限是当前用户，以上文件需要放入当前用户的开机启动文件夹，即为 ~/Library/LaunchAgents 。</p>\n<p>然后将plist文件加入开启启动：</p>\n<pre><code>launchctl load ~/Library/LaunchAgents/boot-shutdown-script.plist\n</code></pre>\n<p>此时重启后，可以使用以下命令查看脚本运行状态</p>\n<pre><code class=\"language-shell\">launchctl list | grep boot\n</code></pre>\n<p>输出为</p>\n<pre><code>438\t0\tboot-shutdown\n</code></pre>\n<p>第一个是pid。第二个为状态码，为0说明正常运行中。</p>\n<hr>\n<p>参考：</p>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/24200924/run-a-script-only-at-shutdown-not-log-off-or-restart-on-mac-os-x\">Run a script only at shutdown (not log off or restart) on Mac OS X</a></li>\n</ul>","content_jsx","const{Fragment:n,jsx:s,jsxs:a}=arguments[0];function _createMdxContent(l){const e={a:\"a\",code:\"code\",h2:\"h2\",hr:\"hr\",li:\"li\",p:\"p\",pre:\"pre\",span:\"span\",ul:\"ul\",...l.components};return a(n,{children:[s(e.p,{children:\"网上讲如何开机运行脚本的很多，但我有关机时关闭远程服务的需求。于是上外网查了一下如何在关机时执行一段脚本。\"}),\"\\n\",s(e.h2,{id:\"新建一个shell文件\",children:\"新建一个shell文件\"}),\"\\n\",s(e.p,{children:\"这个shell中包含了你需要开机关机时运行的脚本。\"}),\"\\n\",s(e.pre,{children:a(e.code,{className:\"hljs language-bash\",children:[s(e.span,{className:\"hljs-meta\",children:\"#!/bin/bash\"}),\"\\n\",s(e.span,{className:\"hljs-keyword\",children:\"function\"}),\" \",s(e.span,{className:\"hljs-function\",children:s(e.span,{className:\"hljs-title\",children:\"shutdown\"})}),\"()\\n{\\n\\n  \",s(e.span,{className:\"hljs-comment\",children:\"# 关机用的脚本放这里\"}),\"\\n\\n  \",s(e.span,{className:\"hljs-built_in\",children:\"exit\"}),\" 0\\n}\\n\\n\",s(e.span,{className:\"hljs-keyword\",children:\"function\"}),\" \",s(e.span,{className:\"hljs-function\",children:s(e.span,{className:\"hljs-title\",children:\"startup\"})}),\"()\\n{\\n\\n  \",s(e.span,{className:\"hljs-comment\",children:\"# 开机用的脚本放这里\"}),\"\\n\\n  \",s(e.span,{className:\"hljs-built_in\",children:\"tail\"}),\" -f /dev/null &\\n  \",s(e.span,{className:\"hljs-built_in\",children:\"wait\"}),\" $!\\n}\\n\\n\",s(e.span,{className:\"hljs-built_in\",children:\"trap\"}),\" shutdown SIGTERM\\n\",s(e.span,{className:\"hljs-built_in\",children:\"trap\"}),\" shutdown SIGKILL\\n\\nstartup;\\n\"]})}),\"\\n\",s(e.p,{children:\"以上文件我取名为launchdeamon，赋予了当前用户的执行权限。\"}),\"\\n\",s(e.pre,{children:s(e.code,{className:\"hljs language-shell\",children:\"chmod 755 launchdaemon\\n\"})}),\"\\n\",s(e.h2,{id:\"新建plist文件\",children:\"新建plist文件\"}),\"\\n\",a(e.p,{children:[\"为了让launchdeamon能在开机时自动运行，需要编写一个相应plist文件，使用launctl做到开机启动。关于launchctl和plist的作用，请先查看这篇文章：\",s(e.a,{href:\"https://www.jianshu.com/p/b65c1d339eec\",children:\"Mac执行定时任务之launchctl\"}),\"。\"]}),\"\\n\",s(e.p,{children:\"plist文件的内容如下：\"}),\"\\n\",s(e.pre,{children:a(e.code,{className:\"hljs language-xml\",children:[a(e.span,{className:\"hljs-meta\",children:[\"<?xml version=\",s(e.span,{className:\"hljs-string\",children:'\"1.0\"'}),\" encoding=\",s(e.span,{className:\"hljs-string\",children:'\"UTF-8\"'}),\"?>\"]}),\"\\n\",a(e.span,{className:\"hljs-meta\",children:[\"<!DOCTYPE \",s(e.span,{className:\"hljs-keyword\",children:\"plist\"}),\" \",s(e.span,{className:\"hljs-keyword\",children:\"PUBLIC\"}),\" \",s(e.span,{className:\"hljs-string\",children:'\"-//Apple//DTD PLIST 1.0//EN\"'}),\" \",s(e.span,{className:\"hljs-string\",children:'\"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"'}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"plist\"}),\" \",s(e.span,{className:\"hljs-attr\",children:\"version\"}),\"=\",s(e.span,{className:\"hljs-string\",children:'\"1.0\"'}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"dict\"}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"Label\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"string\"}),\">\"]}),\"boot-shutdown\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"string\"}),\">\"]}),\"\\n\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"ProgramArguments\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"array\"}),\">\"]}),\"\\n  \",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"string\"}),\">\"]}),\"$SCRIPT_PATH/launchdaemon\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"string\"}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"array\"}),\">\"]}),\"\\n\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"RunAtLoad\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"true\"}),\"/>\"]}),\"\\n\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"StandardOutPath\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"string\"}),\">\"]}),\"$LOG_PATH/boot-shutdown.log\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"string\"}),\">\"]}),\"\\n\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"StandardErrorPath\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"key\"}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"<\",s(e.span,{className:\"hljs-name\",children:\"string\"}),\">\"]}),\"$PLOG_PATH/boot-shutdown.err\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"string\"}),\">\"]}),\"\\n\\n\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"dict\"}),\">\"]}),\"\\n\",a(e.span,{className:\"hljs-tag\",children:[\"</\",s(e.span,{className:\"hljs-name\",children:\"plist\"}),\">\"]}),\"\\n\"]})}),\"\\n\",s(e.p,{children:\"plist文件以键值对的形式存储信息。以上文件的字段解释：\"}),\"\\n\",a(e.ul,{children:[\"\\n\",a(e.li,{children:[s(e.code,{children:\"Label\"}),\"：标签，也就是运行该plist显示的名字。这里为boot-shutdown\"]}),\"\\n\",a(e.li,{children:[s(e.code,{children:\"ProgramArguments\"}),\"：\",s(e.code,{children:\"array\"}),\"里可以存放多个需要运行程序。这里的\",s(e.code,{children:\"$SCRIPT_PATH\"}),\"请自己修改。\"]}),\"\\n\",a(e.li,{children:[s(e.code,{children:\"RunAtLoad\"}),\"：开机自启，为\",s(e.code,{children:\"true\"})]}),\"\\n\",a(e.li,{children:[s(e.code,{children:\"StandardOutPath\"}),\"：打印标准输出到某个文件，方便查看程序后台运行的结果，\",s(e.code,{children:\"$LOG_PATH\"}),\"自行修改。\"]}),\"\\n\",a(e.li,{children:[s(e.code,{children:\"StandardErrorPath\"}),\"：打印标准错误到某个文件，同上。\"]}),\"\\n\"]}),\"\\n\",s(e.p,{children:\"以上文件我取名为 boot-shutdown-script.plist 。\"}),\"\\n\",s(e.p,{children:\"由于shell脚本的执行权限是当前用户，以上文件需要放入当前用户的开机启动文件夹，即为 ~/Library/LaunchAgents 。\"}),\"\\n\",s(e.p,{children:\"然后将plist文件加入开启启动：\"}),\"\\n\",s(e.pre,{children:s(e.code,{children:\"launchctl load ~/Library/LaunchAgents/boot-shutdown-script.plist\\n\"})}),\"\\n\",s(e.p,{children:\"此时重启后，可以使用以下命令查看脚本运行状态\"}),\"\\n\",s(e.pre,{children:s(e.code,{className:\"hljs language-shell\",children:\"launchctl list | grep boot\\n\"})}),\"\\n\",s(e.p,{children:\"输出为\"}),\"\\n\",s(e.pre,{children:s(e.code,{children:\"438\\t0\\tboot-shutdown\\n\"})}),\"\\n\",s(e.p,{children:\"第一个是pid。第二个为状态码，为0说明正常运行中。\"}),\"\\n\",s(e.hr,{}),\"\\n\",s(e.p,{children:\"参考：\"}),\"\\n\",a(e.ul,{children:[\"\\n\",s(e.li,{children:s(e.a,{href:\"https://stackoverflow.com/questions/24200924/run-a-script-only-at-shutdown-not-log-off-or-restart-on-mac-os-x\",children:\"Run a script only at shutdown (not log off or restart) on Mac OS X\"})}),\"\\n\"]})]})}return{default:function(n={}){const{wrapper:a}=n.components||{};return a?s(a,{...n,children:s(_createMdxContent,{...n})}):_createMdxContent(n)}};","toc",[29,35],{"_7":30,"_31":32,"_33":34},"新建一个shell文件","url","#新建一个shell文件","items",[],{"_7":36,"_31":37,"_33":38},"新建plist文件","#新建plist文件",[],"tags",[41],"shell","categories","工具","keywords",[46,41,47,48],"Mac","自动化","脚本","permalink","/posts/Mac上如何开机与关机时自动运行Shell脚本","prevPost",{"_7":53,"_9":53},"关于指针与Golang的结构体","nextPost",{"_7":56,"_9":56},"关于Golang程序的内存占用过大的问题"]
